<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Home - Instaclone</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- jQuery for AJAX -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body class="bg-gray-900 text-white">

<!-- Navigation Bar -->
<nav class="bg-gray-800 p-4 flex justify-between items-center shadow-md">
    <div class="text-2xl font-bold">Instaclone</div>

    <!-- Search Form -->
    <form action="{% url 'search_users' %}" method="GET" class="flex space-x-2">
        <input type="text" name="q" placeholder="Search users..." class="w-full p-2 rounded bg-gray-700 text-white">
        <button type="submit" class="bg-blue-600 px-3 py-1 rounded hover:bg-blue-500">Search</button>
    </form>

    <!-- Navigation Links -->
    <div class="space-x-4 text-base">
        <a href="{% url 'home' %}" class="hover:text-blue-400">Home</a>
        <a href="{% url 'profile' %}" class="hover:text-blue-400">Profile</a>
        <a href="{% url 'edit_profile' %}" class="hover:text-blue-400">Edit Profile</a>
        <a href="{% url 'logout' %}" class="hover:text-blue-400">Logout</a>
    </div>
</nav>

<!-- Stories Section - Instagram Style -->
<div class="max-w-2xl mx-auto px-4 py-4">
    <div class="flex space-x-4 overflow-x-auto pb-4 hide-scrollbar">
        <!-- Your Story (Add Button) -->
        <div class="flex flex-col items-center">
            <div class="relative">
                <!-- Your Profile Picture -->
                {% if request.user.profile_picture %}
                    <img src="{{ request.user.profile_picture.url }}" class="w-16 h-16 rounded-full object-cover border-2 border-gray-400">
                {% else %}
                    <div class="w-16 h-16 rounded-full bg-gray-600 border-2 border-gray-400"></div>
                {% endif %}
                
                <!-- Add Story Button (+) -->
                <label for="story-file-input" class="absolute bottom-0 right-0 bg-blue-600 rounded-full p-1 cursor-pointer hover:bg-blue-700">
                    <span class="text-white text-lg">+</span>
                </label>
                
                <!-- Hidden File Input -->
                <input type="file" id="story-file-input" accept="image/*,video/*" class="hidden" onchange="handleStoryUpload(this.files[0])">
            </div>
            <p class="text-xs mt-1 text-gray-400">Your story</p>
        </div>
        
        <!-- Other Users Stories -->
        {% for story_user in stories_users %}
        <div class="flex flex-col items-center">
            <a href="{% url 'view_story' story_user.latest_story_id %}" class="w-16 h-16 rounded-full bg-gradient-to-r from-purple-500 to-pink-500 p-1 hover:scale-105 transition">
                {% if story_user.profile_picture %}
                    <img src="{{ story_user.profile_picture.url }}" class="w-full h-full rounded-full object-cover border-2 border-gray-900">
                {% else %}
                    <div class="w-full h-full rounded-full bg-gray-600 border-2 border-gray-900"></div>
                {% endif %}
            </a>
            <p class="text-xs mt-1 text-gray-400 truncate" style="max-width: 64px;">{{ story_user.username }}</p>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Main Content -->
<div class="max-w-2xl mx-auto mt-6 space-y-6 px-4" id="posts-container">
    {% if posts %}
        {% for post in posts %}
        <div class="bg-gray-800 rounded shadow p-4 hover:shadow-lg transition" id="post-{{ post.id }}">
            <!-- User Information -->
            <div class="flex items-center space-x-4 mb-2">
                {% if post.user.profile_picture %}
                    <img src="{{ post.user.profile_picture.url }}" class="w-10 h-10 rounded-full object-cover">
                {% else %}
                    <div class="w-10 h-10 rounded-full bg-gray-600"></div>
                {% endif %}
                <p class="font-bold">
                    <a href="{% url 'user_profile' post.user.username %}" class="hover:underline">
                        {{ post.user.username }}
                    </a>
                </p>
            </div>

            <!-- Post Media -->
            {% if post.image %}
                <a href="{% url 'post_detail' post.id %}">
                    <img src="{{ post.image.url }}" alt="Post Image" class="w-full rounded mb-2 object-cover max-h-96 cursor-pointer">
                </a>
            {% elif post.video and post.video.url %}
                <a href="{% url 'post_detail' post.id %}">
                    <div class="w-full rounded mb-2 bg-black relative cursor-pointer" style="height: 384px;">
                        <video class="w-full h-full object-cover rounded" muted>
                            <source src="{{ post.video.url }}" type="video/mp4">
                        </video>
                        <div class="absolute inset-0 flex items-center justify-center">
                            <span class="text-white text-3xl bg-black bg-opacity-50 rounded-full p-2">‚ñ∂Ô∏è</span>
                        </div>
                    </div>
                </a>
            {% else %}
                <!-- Fallback -->
                <div class="w-full h-40 bg-gray-600 rounded mb-2 flex items-center justify-center">
                    <span class="text-white">No media</span>
                </div>
            {% endif %}

            <!-- Post Caption -->
            <p class="mb-2">{{ post.caption }}</p>

            <!-- Engagement Buttons -->
            <div class="flex items-center space-x-4 mb-3">
                <!-- Like Button -->
                <button onclick="toggleLike({{ post.id }})" class="flex items-center space-x-1 hover:text-red-500 like-btn-{{ post.id }}">
                    {% if post.is_liked %}
                        <span class="text-red-500" id="like-icon-{{ post.id }}">‚ù§Ô∏è</span>
                    {% else %}
                        <span id="like-icon-{{ post.id }}">ü§ç</span>
                    {% endif %}
                    <span id="like-count-{{ post.id }}">({{ post.likes_count }})</span>
                </button>
                
                <!-- Comment Button -->
                <a href="{% url 'post_detail' post.id %}" class="flex items-center space-x-1 hover:text-blue-400">
                    <span>üí¨</span>
                    <span id="comment-count-{{ post.id }}">({{ post.comments_count }})</span>
                </a>
            </div>

            <!-- Comment Form -->
            <form onsubmit="addComment(event, {{ post.id }})" class="flex items-center space-x-2 mt-2">
                <input type="text" id="comment-text-{{ post.id }}" placeholder="Add a comment..." 
                       class="flex-1 bg-gray-700 rounded-full px-3 py-1 text-sm">
                <button type="submit" class="text-blue-400 text-sm">Post</button>
            </form>

            <!-- Comments Section -->
            <div class="mt-2 space-y-2" id="comments-container-{{ post.id }}">
                {% for comment in post.comment_set.all|slice:":3" %}
                    <div class="flex items-start justify-between" id="comment-{{ comment.id }}">
                        <div class="flex-1">
                            <p class="text-gray-300 text-sm">
                                <span class="font-bold">{{ comment.user.username }}</span>: {{ comment.text }}
                            </p>
                            <div class="flex items-center space-x-3 mt-1">
                                <span class="text-gray-500 text-xs">{{ comment.created_at|timesince }} ago</span>
                                
                                <!-- Comment Like Button -->
                                <button onclick="toggleCommentLike({{ comment.id }})" class="flex items-center space-x-1 text-gray-500 hover:text-red-400 text-xs comment-like-btn-{{ comment.id }}">
                                    {% if comment.is_liked %}
                                        <span class="text-red-400" id="comment-like-icon-{{ comment.id }}">‚ù§Ô∏è</span>
                                    {% else %}
                                        <span id="comment-like-icon-{{ comment.id }}">ü§ç</span>
                                    {% endif %}
                                    <span id="comment-like-count-{{ comment.id }}">({{ comment.likes_count }})</span>
                                </button>
                            </div>
                        </div>
                    </div>
                {% endfor %}
                
                {% if post.comments_count > 3 %}
                    <a href="{% url 'post_detail' post.id %}" class="text-gray-400 text-sm hover:underline">
                        View all {{ post.comments_count }} comments
                    </a>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    {% else %}
        <p class="text-center text-gray-400">No posts yet. Follow users to see their posts!</p>
    {% endif %}
</div>

<style>
.hide-scrollbar {
    -ms-overflow-style: none;  
    scrollbar-width: none;  
}
.hide-scrollbar::-webkit-scrollbar {
    display: none;  
}
</style>

<script>
// CSRF Token for AJAX
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Handle story upload from home page
function handleStoryUpload(file) {
    if (!file) return;
    
    // Create form data
    const formData = new FormData();
    formData.append('image', file);
    
    // Send AJAX request
    fetch('/story/create/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Refresh page to show new story
            window.location.reload();
        } else {
            alert('Error uploading story: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error uploading story');
    });
}

// Like/Unlike Post
function toggleLike(postId) {
    $.ajax({
        url: `/post/${postId}/like/`,
        type: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        success: function(response) {
            const likeIcon = $(`#like-icon-${postId}`);
            const likeCount = $(`#like-count-${postId}`);
            
            if (response.liked) {
                likeIcon.html('‚ù§Ô∏è').addClass('text-red-500');
                likeCount.text(`(${response.likes_count})`);
            } else {
                likeIcon.html('ü§ç').removeClass('text-red-500');
                likeCount.text(`(${response.likes_count})`);
            }
        },
        error: function(xhr, status, error) {
            console.error('Error:', error);
        }
    });
}

// Add Comment
function addComment(event, postId) {
    event.preventDefault();
    const commentText = $(`#comment-text-${postId}`).val().trim();
    
    if (!commentText) return;
    
    $.ajax({
        url: `/post/${postId}/comment/`,
        type: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        data: {
            text: commentText
        },
        success: function(response) {
            if (response.success) {
                // Clear input
                $(`#comment-text-${postId}`).val('');
                
                // Update comment count
                const commentCount = $(`#comment-count-${postId}`);
                commentCount.text(`(${response.comments_count})`);
                
                // Add new comment to the comments section
                const commentsContainer = $(`#comments-container-${postId}`);
                const newCommentHtml = `
                    <div class="flex items-start justify-between" id="comment-${response.comment_id}">
                        <div class="flex-1">
                            <p class="text-gray-300 text-sm">
                                <span class="font-bold">${response.username}</span>: ${commentText}
                            </p>
                            <div class="flex items-center space-x-3 mt-1">
                                <span class="text-gray-500 text-xs">just now</span>
                                <button onclick="toggleCommentLike(${response.comment_id})" class="flex items-center space-x-1 text-gray-500 hover:text-red-400 text-xs comment-like-btn-${response.comment_id}">
                                    <span id="comment-like-icon-${response.comment_id}">ü§ç</span>
                                    <span id="comment-like-count-${response.comment_id}">(0)</span>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                // Add new comment at the top
                commentsContainer.prepend(newCommentHtml);
            }
        },
        error: function(xhr, status, error) {
            console.error('Error:', error);
        }
    });
}

// Like/Unlike Comment
function toggleCommentLike(commentId) {
    $.ajax({
        url: `/comment/${commentId}/like/`,
        type: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        success: function(response) {
            const likeIcon = $(`#comment-like-icon-${commentId}`);
            const likeCount = $(`#comment-like-count-${commentId}`);
            
            if (response.liked) {
                likeIcon.html('‚ù§Ô∏è').addClass('text-red-400');
                likeCount.text(`(${response.likes_count})`);
            } else {
                likeIcon.html('ü§ç').removeClass('text-red-400');
                likeCount.text(`(${response.likes_count})`);
            }
        },
        error: function(xhr, status, error) {
            console.error('Error:', error);
        }
    });
}
</script>

</body>
</html>